var DEFAULT_INPUT_EXT,MODE,SLEET_FILE,VERSION,checkExists,compileDir,compileFile,compileIt,convert,dirfiles,fs,getDirctoryFiles,getOutputFile,isTarget,mkdirp,path,runIt,yargs;fs=require("fs"),path=require("path"),convert=require("./converter").convert,SLEET_FILE=".sleet",DEFAULT_INPUT_EXT="html",MODE=511&~process.umask(),VERSION="Sleet version 0.0.1",yargs=require("yargs").usage("$0 [options] input.st [input2.st...]").describe("o","The output directory").describe("e","The file extension of input file. Default is html").describe("v","Show the version number").describe("h","Show this message").alias("o","output").alias("e","extension").alias("v","version").alias("h","help")["boolean"]("v")["boolean"]("h").string("e").string("o"),exports.run=function(){var e;return e=yargs.argv,e.files=e._.slice(),e.h?yargs.showHelp():e.v?console.log(VERSION):runIt(e)},runIt=exports.runIt=function(e){var t,r,i,s,o;if(r=checkExists(e.files||[]),r.length>0){for(o=[],i=0,s=r.length;s>i;i++)t=r[i],o.push((fs.statSync(t).isDirectory()?compileDir:compileFile)(t,e));return o}},checkExists=function(e){var t,r,i,s;for(s=[],r=0,i=e.length;i>r;r++)t=e[r],fs.existsSync(t)?s.push(path.resolve(t)):console.error("The specified file '"+t+"' is not exists");return s},compileFile=function(e,t){return compileIt(e,getOutputFile(e,t),t)},compileDir=function(e,t){var r,i,s,o,n;for(o=getDirctoryFiles(path.resolve(e),t.e||DEFAULT_INPUT_EXT),n=[],i=0,s=o.length;s>i;i++)r=o[i],n.push(compileIt(r,getOutputFile(r,t,e),t));return n},getDirctoryFiles=function(e,t){var r;return r=[],dirfiles(e,r,t),r},dirfiles=function(e,t,r){var i,s,o,n,a,l;for(a=fs.readdirSync(e),l=[],s=0,o=a.length;o>s;s++)i=a[s],n=path.join(e,i),fs.statSync(n).isDirectory()?l.push(dirfiles(n,t,r)):isTarget(n,r)?l.push(t.push(n)):l.push(void 0);return l},isTarget=function(e,t){return path.extname(e).slice(1)===t},compileIt=function(e,t,r){var i,s,o,n;console.log((new Date).toLocaleTimeString()+" - Start to convert '"+e+"'"),i=fs.readFileSync(e,"utf8");try{n=convert(i)}catch(o){return s=o,console.log(s.stack)}return fs.writeFileSync(t,n,"utf8"),console.log((new Date).toLocaleTimeString()+" - Converted '"+e+"' to '"+t+"'")},getOutputFile=function(e,t,r){var i,s;return s=path.basename(e,path.extname(e))+SLEET_FILE,i=path.dirname(e),r||(r=i),t.o?(i=path.join(path.resolve("."),t.o,path.relative(r,i)),mkdirp(i),path.join(i,s)):path.join(i,s)},mkdirp=function(e){return fs.existsSync(e)?void 0:(mkdirp(path.dirname(e)),fs.mkdir(e,MODE))};