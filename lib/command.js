var DEFAULT_INPUT_EXT,MODE,SLEET_FILE,VERSION,checkExists,compileDir,compileFile,compileIt,convert,dirfiles,fs,getDirctoryFiles,getOutputFile,isTarget,mkdirp,path,runIt,yargs;fs=require("fs"),path=require("path"),convert=require("./converter").convert,SLEET_FILE=".sleet",DEFAULT_INPUT_EXT="html",MODE=511&~process.umask(),VERSION="Sleet version 0.0.1",yargs=require("yargs").usage("$0 [options] input.st [input2.st...]").describe("o","The output directory").describe("e","The file extension of input file. Default is html").describe("v","Show the version number").describe("h","Show this message").alias("o","output").alias("e","extension").alias("v","version").alias("h","help")["boolean"]("v")["boolean"]("h").string("e").string("o"),exports.run=function(){var e;return e=yargs.argv,e.files=e._.slice(),e.h?yargs.showHelp():e.v?console.log(VERSION):runIt(e)},runIt=exports.runIt=function(e){var t,r,i,o,n;if(r=checkExists(e.files||[]),r.length>0){for(n=[],i=0,o=r.length;o>i;i++)t=r[i],n.push((fs.statSync(t).isDirectory()?compileDir:compileFile)(t,e));return n}},checkExists=function(e){var t,r,i,o;for(o=[],r=0,i=e.length;i>r;r++)t=e[r],fs.existsSync(t)?o.push(path.resolve(t)):console.error("The specified file '"+t+"' is not exists");return o},compileFile=function(e,t){return compileIt(e,getOutputFile(e,t),t)},compileDir=function(e,t){var r,i,o,n,s;for(n=getDirctoryFiles(path.resolve(e),t.e||DEFAULT_INPUT_EXT),s=[],i=0,o=n.length;o>i;i++)r=n[i],s.push(compileIt(r,getOutputFile(r,t,e),t));return s},getDirctoryFiles=function(e,t){var r;return r=[],dirfiles(e,r,t),r},dirfiles=function(e,t,r){var i,o,n,s,a,l;for(a=fs.readdirSync(e),l=[],o=0,n=a.length;n>o;o++)i=a[o],s=path.join(e,i),l.push(fs.statSync(s).isDirectory()?dirfiles(s,t,r):isTarget(s,r)?t.push(s):void 0);return l},isTarget=function(e,t){return path.extname(e).slice(1)===t},compileIt=function(e,t){var r,i,o;console.log((new Date).toLocaleTimeString()+" - Start to convert '"+e+"'"),r=fs.readFileSync(e,"utf8");try{o=convert(r)}catch(n){return i=n,console.log(i.stack)}return fs.writeFileSync(t,o,"utf8"),console.log((new Date).toLocaleTimeString()+" - Converted '"+e+"' to '"+t+"'")},getOutputFile=function(e,t,r){var i,o;return o=path.basename(e,path.extname(e))+SLEET_FILE,i=path.dirname(e),r||(r=i),t.o?(i=path.join(path.resolve("."),t.o,path.relative(r,i)),mkdirp(i),path.join(i,o)):path.join(i,o)},mkdirp=function(e){return fs.existsSync(e)?void 0:(mkdirp(path.dirname(e)),fs.mkdir(e,MODE))};