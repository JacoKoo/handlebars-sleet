var Context,converter,parser,typeMap,util;Context=require("./context"),parser=require("./parser"),util={getHash:function(e){var t,n,r;for(null==e&&(e=[]),n=0,r=e.length;r>n;n++)if(t=e[n],"html_attribute"===t.type&&t.value&&"id"===t.name&&1===t.value.length&&"text"===t.value[0].type)return t.used=!0,t.value[0].value.trim();return!1},getDots:function(e){var t,n,r,u,l,a,h,s,i,o,p,c,v;for(null==e&&(e=[]),r=[],u=0,h=e.length;h>u;u++)if(t=e[u],"html_attribute"===t.type&&t.value&&"class"===t.name){for(c=0,o=t.value,l=0,s=o.length;s>l;l++)v=o[l],"text"===v.type&&(v.used=!0,c++,r=r.concat(v.value.split(/\s+/)));c===t.value.length&&(t.used=!0)}for(p=[],a=0,i=r.length;i>a;a++)n=r[a],n&&p.push(n);return p},checkChildrenOfHanlebarsBlockWithinHtmlAttribute:function(e){var t,n,r,u;for(u=[],n=0,r=e.length;r>n;n++)if(t=e[n],"html_attribute"!==t.type)throw new Error("The children of handlebars block which is placed in html attributes can only contains html attributes");return u}},converter={doctype:function(e,t,n,r){return r.indent(n).push("doctype ").push("html").eol()},comments:function(e,t,n,r){var u,l,a,h,s;if(r.indent(n),1===e.value.length)return r.push("# ").push(e.value[0]).eol();for(r.indent(n).push("#."),h=e.value,s=[],l=0,a=h.length;a>l;l++)u=h[l],u&&s.push(r.indent(n+1).push(u.trim()).eol());return s},textTag:function(e,t,n,r,u){var l,a,h,s,i;if(0===u&&1===e.value.length)return r.pop().push(" ").push(e.value[0].trim()).eol();if(1===e.value.length)return r.indent(n).push("| ").push(e.value[0].trim()).eol();for(r.indent(n).push("|."),s=e.value,i=[],a=0,h=s.length;h>a;a++)l=s[a],l&&i.push(r.indent(n+1).push(l.trim()).eol());return i},htmlTag:function(e,t,n,r){var u,l,a,h,s;for(r.indent(n).push(e.name),a=util.getHash(e.attributes),a&&r.push("#").push(a),l=util.getDots(e.attributes),h=0,s=l.length;s>h;h++)u=l[h],r.push(".").push(u);return converter.htmlAttributes(e.attributes,e,n,r),r.eol(),e.selfClosing?void 0:converter.children(e.children,e,n+1,r)},htmlAttributes:function(e,t,n,r){var u,l,a,h,s,i,o,p,c,v,d;if(e&&(converter.handlebarsBlockInHtmlAttributes(e,t,n,r),d=function(){var t,n,r;for(r=[],t=0,n=e.length;n>t;t++)u=e[t],u.used||r.push(u);return r}(),0!==d.length)){for(l=[],r.push("("),h=i=0,p=d.length;p>i;h=++i)u=d[h],a=converter.htmlAttribute(u,t,n,r,h===d.length-1),l=l.concat(a);if(r.push(")"),l.length>0){for(v=[],o=0,c=l.length;c>o;o++)s=l[o],v.push(converter.handlebarsBlockInHtmlAttributeValue(s.name,s.tag,t,n,r));return v}}},htmlAttribute:function(e,t,n,r,u){var l,a,h,s,i,o;if(l=[],r.push(e.name),e.value)for(a=!1,r.push("="),i=e.value,h=0,s=i.length;s>h;h++)o=i[h],o.used||(a&&r.push(" + "),"text"===o.type?(r.push("'"+o.value+"'"),a=!0):"handlebars"===o.type&&o.selfClosing===!0?(r.push(o.name),a=!0):"handlebars"!==o.type||o.selfClosing||l.push({name:e.name,tag:o}));return u||r.push(" "),l},handlebarsBlockInHtmlAttributes:function(e,t,n,r){var u,l,a,h;for(h=[],l=0,a=e.length;a>l;l++)u=e[l],"handlebars"===u.type&&(u.used=!0,util.checkChildrenOfHanlebarsBlockWithinHtmlAttribute(u.children),converter.htmlAttributes(u.children,t,n,r),r.push("&").push(u.name),h.push(converter.handlebarsAttributes(u.attributes,u,n,r)));return h},handlebarsBlockInHtmlAttributeValue:function(e,t,n,r,u){var l,a,h,s,i;for(u.push("(").push(e).push("="),l=!1,i=t.children,h=0,s=i.length;s>h;h++)a=i[h],l&&u.push(" + "),"text"===a.type&&(u.push("'"+a.value.join("")+"'"),l=!0),"handlebars"===a.type&&u.push(a.name);return u.push(")&").push(t.name),converter.handlebarsAttributes(t.attributes,t,r,u)},handlebarsTag:function(e,t,n,r){return r.indent(n),e.selfClosing&&!e.attributes?r.push("echo("+e.name+")").eol():(r.push(e.name),converter.handlebarsAttributes(e.attributes,e,n,r),r.eol(),e.selfClosing?void 0:converter.children(e.children,e,n+1,r))},handlebarsAttributes:function(e,t,n,r){var u,l,a,h;if(e){for(r.push("("),u=!1,a=0,h=e.length;h>a;a++)l=e[a],"handlebars_attribute"===l.type&&(u&&r.push(" "),l.value?(r.push(l.name.value).push("="),r.push("quoted"===l.value.type?"'"+l.value.value+"'":l.value.value),u=!0):(r.push("quoted"===l.name.type?"'"+l.name.value+"'":l.name.value),u=!0));return r.push(")")}},children:function(e,t,n,r){var u,l,a,h,s;for(s=[],u=a=0,h=e.length;h>a;u=++a)l=e[u],s.push(typeMap[l.type](l,t,n,r,u));return s}},typeMap={doctype:converter.doctype,comment:converter.comments,html:converter.htmlTag,handlebars:converter.handlebarsTag,text:converter.textTag},exports.convert=function(e,t){var n,r,u;null==t&&(t={}),n=new Context(t.indentToken,t.newlineToken);try{u=parser.parse(e)}catch(l){throw r=l,r instanceof parser.SyntaxError?new Error(r.message+" [line: "+r.line+", column: "+r.column+"]"):r}return converter.children(u,{},0,n),n.getOutput()};